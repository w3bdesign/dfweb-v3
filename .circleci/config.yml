
version: 2.1
orbs:
  cypress: cypress-io/cypress@3.3.1
  codecov: codecov/codecov@4.0.1
executors:
  with-chrome-and-firefox:
    docker:
      # - image: "cypress/browsers:node16.14.2-slim-chrome100-ff99-edge"
      # - image: "cypress/browsers:node-20.11.0-chrome-121.0.6167.184-1-ff-123.0-edge-121.0.2277.128-1"
        - image: "cypress/browsers:node-20.10.0-chrome-118.0.5993.88-1-ff-118.0.2-edge-118.0.2088.46-1"
    resource_class: large
jobs:
  cypress-run-with-electron:
      executor: with-chrome-and-firefox
      steps:
        - checkout       
        - run: npm install
        - save_cache:
            key: v1-dependenciesx-{{ checksum "package.json" }}
            paths:
              - node_modules 
        - run: npm run dev       
        - run:
            name: Run Cypress E2E tests with Electron
            command: |              
              npx cypress run --browser electron


  chromatic-deployment:
    docker:
      - image: cimg/node:21.6.2
    working_directory: ~/chromatic
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies-cache
      - run: yarn install
      - run: yarn chromatic --project-token=${CHROMATIC_PROJECT_TOKEN}
  build:
    working_directory: /home/circleci/dfweb
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install NVM and Node.js
          command: |
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
            echo 'export NVM_DIR="$HOME/.nvm"' >> $BASH_ENV
            echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"' >> $BASH_ENV
            source $BASH_ENV
            nvm install 18.17.0
      - run:
          name: Verify Node.js version
          command: |
            source $BASH_ENV
            node --version
      - restore_cache:
          key: npm-cache-v2-{{ checksum "package-lock.json" }}
      - run:
          name: Install Dependencies
          command: npm ci
      - run:
          name: Chrome key start setup
          command: sudo apt update -y
      - run:
          name: Chrome key finish setup
          command: wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
      - run:
          name: Chrome package download
          command: sudo apt install ./google-chrome-stable_current_amd64.deb
      - save_cache:
          key: npm-cache-v1-{{ checksum "package-lock.json" }}
          paths:
            - /home/circleci/.npm
      - store_artifacts:
          path: /root/.npm/_logs
      - run:
          name: Run Jest Tests
          command: npm test
      - codecov/upload
    parallelism: 6
workflows:
  chromatic-deploy:
    jobs:
      - build:
          name: Build Next.js project
      # - chromatic-deployment:
      #     name: Check build with Chromatic
      - cypress-run-with-electron:
            name: Run Cypress E2E tests with Electron
              #cypress-command: npx cypress run --browser electron
              #start-command: npm run dev
              #parallelism: 8
